# üîí –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ AI SQL Advisor

**–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞:** 2025-12-19  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** –ü–æ—Å–ª–µ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò –û–ë–ù–ê–†–£–ñ–ï–ù–´**

---

## ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠–¢–û –°–¢–ê–†–´–ô –ê–£–î–ò–¢

**–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç:** –°–º. `docs/SECURITY_AUDIT_2025_12_23.md`

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –°–º. –Ω–æ–≤—ã–π –∞—É–¥–∏—Ç –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

---

## üìã Executive Summary

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç **—Å–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**, –∫–æ—Ç–æ—Ä—ã–µ **–ù–ï–î–û–ü–£–°–¢–ò–ú–´** –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ SaaS-—Å–µ—Ä–≤–∏—Å–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–æ–¥–ø–∏—Å–∫–∏ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### 1. ‚ùå –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –ë–î –≤ localStorage (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–∞—Ä–æ–ª–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **localStorage** –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
- `localStorage.setItem("savedConnections", JSON.stringify(list))` - —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–æ–ª–∏
- `localStorage.setItem("lastConnection", JSON.stringify({ connectionString: url }))` - —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ø–∞—Ä–æ–ª–µ–º

**–§–∞–π–ª—ã:**
- `components/connections/SimpleDbConnect.tsx:40, 148`
- `components/SqlBuilderPanel/ConnectionsPanel.tsx:57`
- `components/SqlBuilderPanel/ConnectionManager.tsx:43`

**–†–∏—Å–∫–∏:**
- XSS –∞—Ç–∞–∫–∞ ‚Üí –∫—Ä–∞–∂–∞ –≤—Å–µ—Ö –ø–∞—Ä–æ–ª–µ–π –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±—Ä–∞—É–∑–µ—Ä—É ‚Üí –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ë–î
- –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å localStorage
- –ù–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Ç–µ–∫—É—â–µ–µ)
localStorage.setItem("savedConnections", JSON.stringify(connections)); // –ø–∞—Ä–æ–ª–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
// 1. –®–∏—Ñ—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (AES-256)
// 2. –•—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Supabase) —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
// 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π
```

---

### 2. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ API endpoints (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- API endpoints (`/api/fetch-query`, `/api/connect-db`, `/api/fetch-schema`) **–ù–ï –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é**
- –õ—é–±–æ–π –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å –∫ –ª—é–±–æ–π –ë–î
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ù–µ—Ç rate limiting

**–§–∞–π–ª—ã:**
- `pages/api/fetch-query.ts` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `connectionString` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `pages/api/connect-db.ts` - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT
- `pages/api/fetch-schema.ts` - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT

**–†–∏—Å–∫–∏:**
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- DDoS –∞—Ç–∞–∫–∏ –Ω–∞ –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø–æ–¥–±–æ—Ä connection strings

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT
import { verifyJWT } from '@/lib/auth';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const user = await verifyJWT(req);
  if (!user) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  const subscription = await checkSubscription(user.id);
  if (!subscription.active) {
    return res.status(403).json({ error: 'Subscription required' });
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ connectionString –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  const connection = await getUserConnection(user.id, connectionString);
  if (!connection) {
    return res.status(403).json({ error: 'Connection not found' });
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

---

### 3. ‚ùå SQL Injection —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –•–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –¥—Ä–∞–π–≤–µ—Ä—ã, –µ—Å—Ç—å —Ä–∏—Å–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ `jsonQuery`
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ SELECT –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–æ–π–¥–µ–Ω–æ

**–§–∞–π–ª—ã:**
- `pages/api/fetch-query.ts:48` - `client.query(firstQuery)` –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- `lib/db/jsonToSql.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –∏–∑ JSON –º–æ–∂–µ—Ç –±—ã—Ç—å —É—è–∑–≤–∏–º–∞

**–†–∏—Å–∫–∏:**
- SQL Injection —á–µ—Ä–µ–∑ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –û–±—Ö–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ SELECT —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã
- –ß—Ç–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é SQL
function validateSQL(sql: string): boolean {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  const dangerous = /(DROP|DELETE|UPDATE|INSERT|ALTER|TRUNCATE|CREATE|GRANT|REVOKE|EXEC|EXECUTE)/i;
  if (dangerous.test(sql)) return false;
  
  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
  const systemTables = /(pg_|information_schema|sys\.|mysql\.)/i;
  if (systemTables.test(sql)) return false;
  
  // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  if (sql.split(';').filter(s => s.trim()).length > 1) return false;
  
  return true;
}
```

---

### 4. ‚ùå –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í –ª–æ–≥–∞—Ö –º–æ–≥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å connection strings (–¥–∞–∂–µ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π)
- JWT —Ç–æ–∫–µ–Ω—ã –º–æ–≥—É—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ü–∞—Ä–æ–ª–∏ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ console.log

**–§–∞–π–ª—ã:**
- `pages/index.tsx:506` - `console.log("ConnectionString —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:", connStr.substring(0, 50) + "...")`
- `components/connections/SimpleDbConnect.tsx:95` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ connection string
- `pages/api/fetch-schema.ts:24` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ connection string

**–†–∏—Å–∫–∏:**
- –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –î–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º Vercel ‚Üí —É—Ç–µ—á–∫–∞ connection strings

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
console.log("ConnectionString:", connectionString.replace(/:[^:@]+@/, ":****@"));

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
// –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å connection strings –≤–æ–æ–±—â–µ
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ ID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
console.log("Connection ID:", connectionId);
```

---

### 5. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è connection strings –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Connection strings –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ –≤ HTTP –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ù–µ—Ç TLS –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –ü–∞—Ä–æ–ª–∏ –≤–∏–¥–Ω—ã –≤ Network tab –±—Ä–∞—É–∑–µ—Ä–∞

**–†–∏—Å–∫–∏:**
- Man-in-the-middle –∞—Ç–∞–∫–∏
- –ü–µ—Ä–µ—Ö–≤–∞—Ç connection strings —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
- –£—Ç–µ—á–∫–∞ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –≤–µ–∑–¥–µ (—É–∂–µ –µ—Å—Ç—å)
- –®–∏—Ñ—Ä–æ–≤–∞—Ç—å connection strings –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π

---

### 6. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ connection string –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å connection string –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–∏—Å–∫–∏:**
- –ö—Ä–∞–∂–∞ connection strings –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –∫—Ç–æ –∫ –∫–∞–∫–æ–π –ë–î –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- –ù–µ—Ç –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ Supabase
CREATE TABLE user_connections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  connection_string_encrypted TEXT NOT NULL, -- –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
  db_type TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏
async function getUserConnection(userId: string, connectionId: string) {
  const { data } = await supabase
    .from('user_connections')
    .select('*')
    .eq('id', connectionId)
    .eq('user_id', userId)
    .single();
  return data;
}
```

---

### 7. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
- –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

**–†–∏—Å–∫–∏:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –±–µ–∑ –æ–ø–ª–∞—Ç—ã
- –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ–¥–ø–∏—Å–æ–∫
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  plan TEXT NOT NULL, -- 'free', 'pro', 'team'
  status TEXT NOT NULL, -- 'active', 'canceled', 'expired'
  stripe_subscription_id TEXT,
  current_period_end TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

// ‚úÖ Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
async function checkSubscription(userId: string) {
  const { data } = await supabase
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'active')
    .gt('current_period_end', new Date().toISOString())
    .single();
  return data;
}
```

---

### 8. ‚ùå –•–∞—Ä–¥–∫–æ–¥ credentials –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `.cursorrules` –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä connection string —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ credentials
- –ü–∞—Ä–æ–ª—å `npg_Kpne6AbEOx1s` –≤–∏–¥–µ–Ω –≤ –∫–æ–¥–µ

**–§–∞–π–ª—ã:**
- `.cursorrules:229` - –ø—Ä–∏–º–µ—Ä —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º

**–†–∏—Å–∫–∏:**
- –£—Ç–µ—á–∫–∞ credentials —á–µ—Ä–µ–∑ Git
- –î–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
- –£–¥–∞–ª–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ credentials
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å `.cursorrules` –≤ `.gitignore` –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –æ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤

---

### 9. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –í–æ–∑–º–æ–∂–Ω—ã DDoS –∞—Ç–∞–∫–∏
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vercel Edge Middleware –∏–ª–∏ Upstash Redis
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, "10 s"), // 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 10 —Å–µ–∫—É–Ω–¥
});

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const identifier = req.headers['x-forwarded-for'] || 'anonymous';
  const { success } = await ratelimit.limit(identifier);
  
  if (!success) {
    return res.status(429).json({ error: 'Too many requests' });
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

---

### 10. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ CORS –∑–∞—â–∏—Ç—ã (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç —è–≤–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS
- –í–æ–∑–º–æ–∂–Ω—ã CSRF –∞—Ç–∞–∫–∏
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ origin

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å CORS middleware
const allowedOrigins = [
  'https://ai-sql-advisor.vercel.app',
  'http://localhost:3000'
];

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const origin = req.headers.origin;
  
  if (origin && !allowedOrigins.includes(origin)) {
    return res.status(403).json({ error: 'Forbidden' });
  }
  
  res.setHeader('Access-Control-Allow-Origin', origin || '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

---

## ‚ö†Ô∏è –°–†–ï–î–ù–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### 11. JWT —Ç–æ–∫–µ–Ω—ã –≤ localStorage

**–ü—Ä–æ–±–ª–µ–º–∞:** JWT —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage, —É—è–∑–≤–∏–º—ã –∫ XSS  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å httpOnly cookies (—Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏)

### 12. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤ connection strings  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–≥—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é

### 13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Sentry, LogRocket –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏

---

## ‚úÖ –ß–¢–û –£–ñ–ï –•–û–†–û–®–û

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS
2. ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö SQL –æ–ø–µ—Ä–∞—Ü–∏–π (DROP, DELETE, etc.)
3. ‚úÖ Read-only –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–≤ —Ç–µ–æ—Ä–∏–∏)
4. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è JWT —Ñ–æ—Ä–º–∞—Ç–∞
5. ‚úÖ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
6. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—á–∞—Å—Ç–∏—á–Ω–æ)

---

## üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô (–ü–†–ò–û–†–ò–¢–ï–¢–´)

### üî¥ –ö–†–ò–¢–ò–ß–ù–û (—Å–¥–µ–ª–∞—Ç—å –î–û –∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏)

1. **–£–±—Ä–∞—Ç—å –ø–∞—Ä–æ–ª–∏ –∏–∑ localStorage**
   - –®–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π

2. **–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ –≤—Å–µ API endpoints**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ connection string –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

3. **–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ Supabase**
   - –¢–∞–±–ª–∏—Ü–∞ `user_connections` —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
   - –°–≤—è–∑—å —Å `auth.users`

4. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏**
   - –¢–∞–±–ª–∏—Ü–∞ `subscriptions`
   - Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Stripe/PayPal

5. **–£—Å–∏–ª–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç SQL Injection**
   - –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è SQL
   - Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

### üü° –í–ê–ñ–ù–û (—Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é)

6. **–î–æ–±–∞–≤–∏—Ç—å rate limiting**
7. **–£–±—Ä–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
8. **–î–æ–±–∞–≤–∏—Ç—å CORS –∑–∞—â–∏—Ç—É**
9. **–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞**

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (—Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü)

10. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**
11. **–ú–∏–≥—Ä–∞—Ü–∏—è JWT –≤ httpOnly cookies**
12. **–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
13. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ connection strings –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ**

---

## üìä –û–¶–ï–ù–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** | üî¥ 2/10 | –ü–∞—Ä–æ–ª–∏ –≤ localStorage, –Ω–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è |
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | üî¥ 3/10 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ API endpoints |
| **–ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π** | üü° 5/10 | –ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞, –Ω—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** | üî¥ 1/10 | –ù–µ—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ |
| **–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è** | üî¥ 0/10 | –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–æ–∫ |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | üî¥ 1/10 | –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞—Ç–∞–∫ |
| **–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞** | üî¥ **2.5/10** | **–ù–ï –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ï–ù–£** |

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –î–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

1. **–ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É** –¥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
2. **–ù–∞–Ω—è—Ç—å security –∞—É–¥–∏—Ç–æ—Ä–∞** –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–í–Ω–µ–¥—Ä–∏—Ç—å DevSecOps** –ø—Ä–∞–∫—Ç–∏–∫–∏
4. **–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤** –Ω–∞ —Å–ª—É—á–∞–π —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö
5. **–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å** –æ—Ç –∫–∏–±–µ—Ä-—Ä–∏—Å–∫–æ–≤

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. **API Gateway** –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. **Secrets Management** (Vault, AWS Secrets Manager)
4. **Database Proxy** –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã –ë–î
5. **WAF (Web Application Firewall)** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞—Ç–∞–∫

---

## üîê –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –î–õ–Ø –ó–ê–ü–£–°–ö–ê

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–æ–¥–ø–∏—Å–∫–∏ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û**:

- [ ] –£–±—Ä–∞—Ç—å –≤—Å–µ –ø–∞—Ä–æ–ª–∏ –∏–∑ localStorage
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ –≤—Å–µ API endpoints
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ Supabase
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –£—Å–∏–ª–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç SQL Injection
- [ ] –î–æ–±–∞–≤–∏—Ç—å rate limiting
- [ ] –£–±—Ä–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å CORS –∑–∞—â–∏—Ç—É
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ penetration testing

---

**–í—ã–≤–æ–¥:** –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ **–ù–ï –ì–û–¢–û–í** –∫ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 2-3 –Ω–µ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–æ–¥–ø–∏—Å–∫–∏.
