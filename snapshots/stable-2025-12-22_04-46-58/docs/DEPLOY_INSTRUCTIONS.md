# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö Edge Functions

## üìÅ –ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

```
supabase/functions/
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù
‚îú‚îÄ‚îÄ generate_sql/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù
‚îú‚îÄ‚îÄ fetch_schema/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù
‚îú‚îÄ‚îÄ execute_sql/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù
‚îî‚îÄ‚îÄ _shared/              ‚úÖ –ù–û–í–´–ï –£–¢–ò–õ–ò–¢–´
    ‚îú‚îÄ‚îÄ auth.ts
    ‚îî‚îÄ‚îÄ validation.ts
```

---

## üîß –ö–∞–∫ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase CLI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
cd c:\Users\Full_Errorist\Documents\GitHub\ai-sql-advisor-next

# 2. –ü—Ä–∏–≤—è–∂–∏—Ç–µ—Å—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã)
supabase link --project-ref zaheofzxbfqabdxdmjtz

# 3. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é
supabase functions deploy schemas
supabase functions deploy generate_sql
supabase functions deploy fetch_schema
supabase functions deploy execute_sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://supabase.com/dashboard/project/zaheofzxbfqabdxdmjtz
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Edge Functions**
3. –î–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é
   - –ù–∞–∂–º–∏—Ç–µ **Edit**
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ñ–∞–π–ª–∞ `supabase/functions/[function-name]/index.ts`
   - –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
   - –ù–∞–∂–º–∏—Ç–µ **Deploy**

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:

### 1. –§—É–Ω–∫—Ü–∏—è `schemas`
**–§–∞–π–ª:** `supabase/functions/schemas/index.ts`  
**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω CORS
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Å—Ö–µ–º—ã
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ö–µ–º

### 2. –§—É–Ω–∫—Ü–∏—è `generate_sql`
**–§–∞–π–ª:** `supabase/functions/generate_sql/index.ts`  
**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ **–î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω CORS
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max_tokens
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3. –§—É–Ω–∫—Ü–∏—è `fetch_schema`
**–§–∞–π–ª:** `supabase/functions/fetch_schema/index.ts`  
**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ **–î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è db_url (SSRF –∑–∞—â–∏—Ç–∞)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ db_url
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω CORS

### 4. –§—É–Ω–∫—Ü–∏—è `execute_sql`
**–§–∞–π–ª:** `supabase/functions/execute_sql/index.ts`  
**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ **–£–ë–†–ê–ù SERVICE_ROLE_KEY** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- ‚úÖ **–î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è SQL
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω CORS

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `supabase/migrations/20251219_security_tables.sql`

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase Dashboard ‚Üí SQL Editor:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å —Ñ–∞–π–ª supabase/migrations/20251219_security_tables.sql
-- –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor
```

–ò–ª–∏ —á–µ—Ä–µ–∑ CLI:
```bash
supabase db push
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Supabase Dashboard ‚Üí Project Settings ‚Üí Edge Functions ‚Üí Secrets:

- `SUPABASE_URL` - —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å
- `SUPABASE_ANON_KEY` - —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å
- `OPENAI_API_KEY` - —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å (–¥–ª—è generate_sql)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```bash
# –ë–µ–∑ JWT —Ç–æ–∫–µ–Ω–∞ - –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 401
curl -X POST https://zaheofzxbfqabdxdmjtz.supabase.co/functions/v1/generate_sql \
  -H "Content-Type: application/json" \
  -d '{"nl": "test"}'
# –û–∂–∏–¥–∞–µ—Ç—Å—è: {"error":"unauthorized"}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```bash
# –° –≤–∞–ª–∏–¥–Ω—ã–º JWT, –Ω–æ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏ - –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 403
curl -X POST https://zaheofzxbfqabdxdmjtz.supabase.co/functions/v1/generate_sql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"nl": "test"}'
# –û–∂–∏–¥–∞–µ—Ç—Å—è: {"error":"Subscription required"}
```

### 3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É

```sql
-- –í SQL Editor Supabase
INSERT INTO subscriptions (user_id, plan, status, current_period_end)
VALUES (
  'YOUR_USER_UUID',  -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  'pro',
  'active',
  NOW() + INTERVAL '30 days'
);
```

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (`20251219_security_tables.sql`)
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `schemas`
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `generate_sql`
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `fetch_schema`
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `execute_sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å JWT —Ç–æ–∫–µ–Ω–æ–º

---

## üîç –ì–¥–µ –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ:

–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤:
- `supabase/functions/schemas/index.ts`
- `supabase/functions/generate_sql/index.ts`
- `supabase/functions/fetch_schema/index.ts`
- `supabase/functions/execute_sql/index.ts`

**–ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Edge Functions –≤ Supabase Dashboard!**
